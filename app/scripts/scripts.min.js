function addFilter(e){var t=$("input[name=filter]"),n=!1;"item name"===e&&(n=!0,e=prompt("Enter an item name:"),e=e.trim());var i=t.val();n?t.val(e+(i.length>0?" "+i:"")):(i+" ").indexOf(e+" ")<0&&(i.length>0?t.val(i+" "+e):t.val(e)),t.change()}!function(){"use strict";angular.module("dimApp",["ui.router","ngAnimate","ngDialog","ngMessages","ang-drag-drop","chromeStorage","angularUUID2","toaster","ajoslin.promise-tracker"])}(),function(){"use strict";angular.module("dimApp").value("dimPlatformIds",{xbl:null,psn:null}).value("dimState",{membershipType:-1,active:null,debug:!0}).value("dimItemTier",{exotic:"Exotic",legendary:"Legendary",rare:"Rare",uncommon:"Uncommon",basic:"Basic"}).value("dimCategory",{Subclass:["Class"],Weapons:["Primary","Special","Heavy"],Armor:["Helmet","Gauntlets","Chest","Leg","ClassItem"],General:["Emblem","Armor","Ghost","Ship","Vehicle","Consumable","Material"]}),angular.module("dimApp").run(function(e,t){e.loadingTracker=t()}),angular.module("dimApp").config(["$compileProvider",function(e){var t=e.imgSrcSanitizationWhitelist(),n=t.toString().slice(0,-1)+"|chrome-extension:"+t.toString().slice(-1);e.imgSrcSanitizationWhitelist(n)}]).config(["rateLimiterConfigProvider",function(e){e.addLimiter(/www\.bungie\.net\/Platform\/Destiny\/TransferItem/,1,1250),e.addLimiter(/www\.bungie\.net\/Platform\/Destiny\/EquipItem/,1,1250)}]).config(["$httpProvider",function(e){e.interceptors.push("rateLimiterInterceptor")}]).config(function(e,t){t.otherwise("/inventory"),e.state("inventory",{url:"/inventory",templateUrl:"views/inventory.html"})})}(),$(document).ready(function(){if(verge.viewportW()!==$(window).width()){$("body").addClass("pad-margin");var e=document.createElement("style");e.type="text/css",e.innerHTML=".about.ngdialog-open.pad-margin #header, .support.ngdialog-open.pad-margin #header, .filters.ngdialog-open.pad-margin #header { padding-right: "+(verge.viewportW()-$(window).width())+"px; }",document.getElementsByTagName("head")[0].appendChild(e)}});var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-60316581-1"]),_gaq.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),function(e){"use strict";e.module("dimApp").factory("rateLimiterQueue",["$interval","$window",function(t,n){function i(e,t,n){this.pattern=e,this.requestLimit=t,this.timeLimit=n||1e3,this.queue=[],this.count=0,this.lastRequest=void 0,this.currentRequest=void 0,this.interval=void 0}function r(e,t,n){return new i(e,t,n)}return i.prototype.matches=function(e){return e.match(this.pattern)},i.prototype.add=function(e,t){this.queue.push({config:e,deferred:t})},i.prototype.remove=function(e){this.queue.splice(e,1)},i.prototype.startProcessing=function(){e.isDefined(this.interval)||(this.interval=t(this.processQueue.bind(this),this.timeLimit))},i.prototype.stopProcessing=function(){e.isDefined(this.interval)&&(t.cancel(this.interval),this.interval=void 0)},i.prototype.processQueue=function(){if(this.queue.length)for(var e=0;e<this.requestLimit;e++){var t=this.queue[e];t&&this.process(t,e)}else this.stopProcessing()},i.prototype.process=function(t,i){var r;this.count++,this.currentRequest=n.performance.now(),e.isDefined(this.lastRequest)||(this.lastRequest=this.currentRequest),r=this.currentRequest-this.lastRequest,r>=this.timeLimit&&(this.count=0),this.count<this.requestLimit?(t.deferred.resolve(t.config),this.lastRequest=this.currentRequest,this.remove(i)):this.startProcessing()},r}]).provider("rateLimiterConfig",function(){var e=[],t=[];this.addLimiter=function(t,n,i){e.push({pattern:t,requestLimit:n,timeLimit:i})},this.$get=["rateLimiterQueue",function(n){for(;e.length;){var i=e.shift();t.push(n(i.pattern,i.requestLimit,i.timeLimit))}return{getLimiters:function(){return t}}}]}).factory("rateLimiterInterceptor",["$q","rateLimiterConfig",function(t,n){return{request:function(i){var r=t.defer(),o=!1;return e.forEach(n.getLimiters(),function(e){e.matches(i.url)&&(e.add(i,r),e.processQueue(),o=!0)}),o||r.resolve(i),r.promise}}}])}(angular),function(){"use strict";function e(e,t,n,i,r,o,a){function s(e,t,n){return e[t]=n,n}function u(e){return e.status>=200&&e.status<400?e:t.reject(new Error("Network error: "+e.status))}function c(e){return t(function(t,n){return 36!==e.data.ErrorCode?t(e):n({errorCode:36,message:"Throttle limit exceeded.  Retry."})})}function l(){return t(function(e,t){function n(n){_.size(n)>0?e(n):t(new Error("No cookies found."))}chrome.cookies.getAll({domain:".bungie.net"},n)})}function d(){return B=B||l().then(function(e){return t(function(t,n){var i=_.find(e,function(e){return"bungled"===e.name});_.isUndefined(i)?(chrome.tabs.query({url:"*://*.bungie.net/*"},function(e){0===_.size(e)&&chrome.tabs.create({url:"http://bungie.net",active:!1})}),n(new Error("No bungled cookie found."))):t(i.value)})})["catch"](function(e){B=null})}function p(){return N=N||d().then(m).then(i).then(u).then(c).then(v)["catch"](function(e){return a.pop("error","",e.message),t.reject(e)})}function m(e){return{method:"GET",url:"https://www.bungie.net/Platform/User/GetBungieNetUser/",headers:{"X-API-Key":j,"x-csrf":e},withCredentials:!0}}function v(e){return 99===e.data.ErrorCode?(chrome.tabs.query({url:"*://*.bungie.net/*"},function(e){0===_.size(e)&&chrome.tabs.create({url:"http://bungie.net",active:!1})}),t.reject(new Error("Please log into Bungie.net before using this extension."))):5===e.data.ErrorCode?t.reject(new Error("Bungie.net servers are down for maintenance.")):e.data.ErrorCode>1?t.reject(new Error(e.data.Message)):e}function f(e){return O=O||d().then(h.bind(null,e)).then(i).then(u).then(c).then(g,y)["catch"](function(e){O=null})}function h(e,n){return t.when(function(){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+e.type+"/Stats/GetMembershipIdByDisplayName/"+e.id+"/",headers:{"X-API-Key":j,"x-csrf":n},withCredentials:!0}}())}function g(e){return"0"===_.size(e.data.Response)?t.reject(new Error("The membership id was not available.")):t.when(e.data.Response)}function y(e){return t.reject(new Error("The membership id request failed."))}function b(e){var t={token:null,membershipId:null},n=s.bind(null,t,"token"),r=(s.bind(null,t,"membershipId"),f.bind(null,e));return H=H||d().then(n).then(r).then(function(n){return q(t.token,e,n)}).then(i).then(u).then(c).then(w,S)}function q(e,n,i){return t.when(function(){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/Tiger"+(1==n.type?"Xbox":"PSN")+"/Account/"+i+"/",headers:{"X-API-Key":j,"x-csrf":e},withCredentials:!0}}())}function w(e){return 5===e.data.ErrorCode?t.reject(new Error("Bungie.net is down for maintenance.")):0===_.size(e.data.Response)?t.reject(new Error("The membership id was not available.")):t.when(function(){return _.map(e.data.Response.data.characters,function(e){return{id:e.characterBase.characterId,base:e}})}())}function S(e){t.reject(new Error("The characters request failed."))}function k(e){var n={token:null,membershipId:null},i=s.bind(null,n,"token"),r=s.bind(null,n,"membershipId"),o=s.bind(null,n,"characters"),u=f.bind(null,e),c=b.bind(null,e),l=d().then(i).then(u).then(r).then(c).then(o).then(function(){return A(n.token,e,n.membershipId,n.characters)})["catch"](function(e){return a.pop("error","",e.message),t.reject(e)});return l}function T(e,t,n,i){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+t.type+"/Account/"+n+"/Character/"+i.id+"/Inventory/?definitions=false",headers:{"X-API-Key":j,"x-csrf":e},withCredentials:!0}}function $(e,t){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+t.type+"/MyAccount/Vault/?definitions=false",headers:{"X-API-Key":j,"x-csrf":e},withCredentials:!0}}function C(e,n){var i=n.data.Response;return i.id=e.id,i.character=e,t.when(i)}function x(e){t.reject(new Error("The store inventory was not available."))}function A(e,n,r,o){var a,s,l=[];return _.each(o,function(o){s=C.bind(null,o),a=t.when(T(e,n,r,o)).then(i).then(u).then(c).then(s,x),l.push(a)}),s=C.bind(null,{id:"vault",base:null}),a=t.when($(e,n)).then(i).then(u).then(c).then(s,x),l.push(a),t.all(l)}function L(e,o){var a=r.active,l=(a.type,{token:null,membershipType:null}),p=s.bind(null,l,"token"),m=s.bind(null,l,"membershipType"),v=f.bind(null,a),h=d().then(p).then(v).then(m).then(function(){return o}).then(function(t){return P(l.token,a.type,e,t)}).then(function(e){return t(function(t,r){function o(){i(e).then(function(e){36===e.data.ErrorCode?(a-=1,0>=a?r(new Error(e.data.Message)):n(o,1e3*Math.pow(2,4-a))):e.data.ErrorCode>1?r(new Error(e.data.Message)):t(e)},function(e){r(new Error(e.data.Message))})}var a=4;o()})}).then(u).then(c).then(function(e){e.status});return h}function P(e,t,n,i){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/TransferItem/",headers:{"X-API-Key":j,"x-csrf":e,"content-type":"application/json; charset=UTF-8;"},data:{characterId:"vault"===i.id?n.owner:i.id,membershipType:t,itemId:n.id,itemReferenceHash:n.hash,stackSize:_.has(n,"moveAmount")&&n.moveAmount>0?n.moveAmount:n.amount,transferToVault:"vault"===i.id},dataType:"json",withCredentials:!0}}function E(e){var o=r.active,a=(o.type,{token:null,membershipType:null}),l=s.bind(null,a,"token"),p=s.bind(null,a,"membershipType"),m=f.bind(null,o),v=d().then(l).then(m).then(p).then(function(){return I(a.token,o.type,e)}).then(function(e){var r=t(function(t,r){function o(){i(e).then(function(e){36===e.data.ErrorCode?(a-=1,0>=a?r(new Error(e.data.Message)):n(o,1e3*Math.pow(2,4-a))):e.data.ErrorCode>1?r(new Error(e.data.Message)):t(e)},function(e){r(new Error(e.data.Message))})}var a=4;o()});return r}).then(u).then(c).then(function(e){e.status});return v}function I(e,t,n){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/EquipItem/",headers:{"X-API-Key":j,"x-csrf":e,"content-type":"application/json; charset=UTF-8;"},data:{characterId:n.owner,membershipType:t,itemId:n.id},dataType:"json",withCredentials:!0}}var j="57c5ff5864634503a0340ffdfbeb20c0",B=null,N=null,O=null,H=null;e.$on("dim-active-platform-updated",function(e,t){B=null,N=null,O=null,H=null});var z={getPlatforms:p,getStores:k,transfer:L,equip:E};return z}angular.module("dimApp").factory("dimBungieService",e),e.$inject=["$rootScope","$q","$timeout","$http","dimState","rateLimiterQueue","toaster"]}(),function(e){"use strict";function t(e,t,n){var i=e.defer();return n.get("scripts/api-manifest/items.json").success(function(e){i.resolve(e)}).error(function(e){i.reject(new Error("The items definition file was not parsed correctly."))}),{getDefinitions:function(){return i.promise}}}e.module("dimApp").factory("dimItemDefinitions",t),t.$inject=["$q","$timeout","$http"]}(angular),function(){"use strict";function e(e,t,n,i){function r(){var e=n.getPlatforms().then(o);return e}function o(t){var n=t.data.Response;return c.splice(0),n.gamerTag&&c.push({id:n.gamerTag,type:1,label:"Xbox"}),n.psnId&&c.push({id:n.psnId,type:2,label:"PlayStation"}),e.$broadcast("dim-platforms-updated",{platforms:c}),a().then(function(e){u(e)}),c}function a(){var e=i.get("platformType").then(function(e){_.isUndefined(e)&&(e=null);var t=null,n=null;return _.isNull(e)||(t=_.find(c,function(t){return t.type===e})),n=_.size(c)>0?_.isNull(l)?t||c[0]:_.find(c,function(e){return e.id===l.id})?l:c[0]:null});return e}function s(){return l}function u(t){l=t;var n;n=_.isNull(t)?i.drop("platformType"):i.set("platformType",t.type),e.$broadcast("dim-active-platform-updated",{platform:l})}var c=[],l=null,d={getPlatforms:r,getActive:s,setActive:u};return d}angular.module("dimApp").factory("dimPlatformService",e),e.$inject=["$rootScope","$q","dimBungieService","chromeStorage"]}(),function(){"use strict";function e(e,t,n,i){function r(e){t.$broadcast("dim-store-item-clicked",{item:e})}function o(e,t){if(_.isUndefined(e))f=f.splice(0);else if("v3.0"===t){var n=e["loadouts-v3.0"];f.splice(0),_.each(n,function(t){f.push(l(e[t]))})}else f.splice(0),e=_.filter(e,function(e){return!_.isNull(e)}),_.each(e,function(e){f.push(l(e))})}function a(t){var n=e.defer(),i=n.promise;return t||0===_.size(f)?chrome.storage.sync.get(null,function(e){_.has(e,"loadouts-v3.0")?o(e,"v3.0"):_.has(e,"loadouts-v2.0")?(o(e["loadouts-v2.0"],"v2.0"),s(f)):o(void 0),n.resolve(f)}):i=e.when(f),i}function s(t){var n,i=e.defer();return n=_.isUndefined(t)?a():e.when(t),n.then(function(e){return f=e,_.map(e,function(e){return v(e)})}).then(function(e){var t={"loadouts-v3.0":[]};return _.each(e,function(e){t["loadouts-v3.0"].push(e.id),t[e.id]=e}),chrome.storage.sync.set(t,function(t){i.resolve(e)}),i.promise})}function u(e){return a().then(function(t){var n=_.findIndex(t,function(t){return t.id===e.id});return n>=0&&t.splice(n,1),chrome.storage.sync.remove(e.id.toString(),function(){}),t}).then(function(e){return s(e)}).then(function(n){return t.$broadcast("dim-delete-loadout",{loadout:e}),n})}function c(e){return a().then(function(t){return _.has(e,"id")||(e.id=n.newguid()),t.push(e),s(t)}).then(function(n){return t.$broadcast("dim-save-loadout",{loadout:e}),n})}function l(e){var t={"v1.0":m,"v2.0":p,"v3.0":d,"default":d};return(t[e.version]||t["v1.0"])(e)}function d(e){var t={id:e.id,name:e.name,classType:_.isUndefined(e.classType)?-1:e.classType,version:"v3.0",items:{}};return _.each(e.items,function(e){var n=_.clone(i.getItem({id:e.id,hash:e.hash}));if(n){var r=n.type.toLowerCase();n.equipped=e.equipped,t.items[r]=t.items[r]||[],t.items[r].push(n)}}),t}function p(e){var t={id:e.id,name:e.name,classType:_.isUndefined(e.classType)?-1:e.classType,version:"v3.0",items:{}};return _.each(e.items,function(e){var n=_.clone(i.getItem({id:e.id,hash:e.hash}));if(n){var r=n.type.toLowerCase();n.equipped=e.equipped,t.items[r]=t.items[r]||[],t.items[r].push(n)}}),t}function m(e){var t={id:n.newguid(),name:e.name,classType:-1,version:"v3.0",items:{}};return _.each(e.items,function(e){var n=_.clone(i.getItem(e));if(n){var r=n.type.toLowerCase();t.items[r]=t.items[r]||[],t.items[r].push(n),n.equipped=!0}}),t}function v(e){var t={id:e.id,name:e.name,classType:e.classType,version:"v3.0",items:[]};return _.chain(e.items).values().flatten().each(function(e){t.items.push({id:e.id,hash:e.hash,amount:e.amount,equipped:e.equipped})}),t}var f=[];return{dialogOpen:!1,getLoadouts:a,deleteLoadout:u,saveLoadouts:s,saveLoadout:c,addItemToLoadout:r}}angular.module("dimApp").factory("dimLoadoutService",e),e.$inject=["$q","$rootScope","uuid2","dimItemService"]}(),function(){"use strict";function e(e,t,n,i,r,o,a){function s(){return y++}function u(){function e(e){var t=getComputedStyle(e),n=parseInt(t.height);return n}var t=function(t,n){var i=0;return _.each(n.children,function(t){var n=e(t);i=i>n?i:n}),i>t&&(t=i),t},n=function(e){var n=_.reduce(document.querySelectorAll(e),t,0),i=document.querySelectorAll("style[id="+e.replace(/\./g,"").replace(/\s/g,"")+"]");i.length>0?i=i[0]:(i=document.createElement("style"),i.type="text/css",i.id=e.replace(/\./g,"").replace(/\s/g,""),document.getElementsByTagName("head")[0].appendChild(i)),i.innerHTML=e+" { min-height: "+n+"px; }"};n(".sub-section.sort-class"),n(".sub-section.sort-primary"),n(".sub-section.sort-special"),n(".sub-section.sort-heavy"),n(".sub-section.sort-helmet"),n(".sub-section.sort-chest"),n(".sub-section.sort-gauntlets"),n(".sub-section.sort-leg"),n(".sub-section.sort-classitem"),n(".sub-section.sort-emblem"),n(".sub-section.sort-armor"),n(".sub-section.sort-ghost"),n(".sub-section.sort-ship"),n(".sub-section.sort-vehicle"),n(".sub-section.sort-consumable"),n(".sub-section.sort-material"),n(".weapons"),n(".armor"),n(".general")}function c(a){if(a){var s=n.getStores(i.getActive()).then(function(e){return g.splice(0),_.each(e,function(e){var t,n=[];"vault"===e.id?(t={id:"vault",icon:"",items:[],bucketCounts:{},hasExotic:function(e){var t={tier:r.exotic,type:e};return _.chain(n).where(t).value()},getTypeCount:function(e){return _.chain(this.items).filter(function(t){return e.type===t.type}).size().value()<10},canEquipExotic:function(e){return this.getTypeCount(e)}},_.each(e.data.buckets,function(e){3003523923===e.bucketHash&&(t.bucketCounts.Armor=_.size(e.items)),138197802===e.bucketHash&&(t.bucketCounts.General=_.size(e.items)),4046403665===e.bucketHash&&(t.bucketCounts.Weapons=_.size(e.items)),n=_.union(n,e.items)})):(t={id:e.id,icon:e.character.base.emblemPath,background:e.character.base.backgroundPath,level:e.character.base.characterLevel,"class":p(e.character.base.characterBase.classType),gender:v(e.character.base.characterBase.genderType),race:m(e.character.base.characterBase.raceHash),isPrestigeLevel:e.character.base.isPrestigeLevel,percentToNextLevel:e.character.base.percentToNextLevel,hasExotic:function(e,t){var n={tier:r.exotic,type:e};return _.isUndefined(t)||(n.equipped=t),_.chain(this.items).where(n).value()},getTypeCount:function(e){return _.chain(this.items).filter(function(t){return e.type===t.type}).size().value()<10},canEquipExotic:function(e){var t=_.chain(o).pairs().find(function(t){return _.some(t[1],function(t){return t==e})}).value()[1];return 0===_.size(_.reduce(t,function(e,t){return e||this.hasExotic(t,!0)},!1,this))}},_.each(e.data.buckets,function(e){_.each(e,function(e){n=_.union(n,e.items)})}));var i=d(t.id,n,e.definitions);i.then(function(e){return e=_.sortBy(e,function(e){return e.name}),e=_.sortBy(e,function(e){switch(e.tier){case"Exotic":return 0;case"Legendary":return 1;case"Rare":return 2;case"Uncommon":return 3;case"Common":return 4;default:return 5}}),t.items=e,g.push(t),t})}),t.when(g)}).then(function(t){return e.$broadcast("dim-stores-updated",{stores:t}),t});return s}return g}function l(e){var n=_.find(g,function(t){return t.id===e});return t.when(n)}function d(e,t,n){var i=[],r=function(t,n,r){var o=t[n.itemHash];if(void 0!==o){var a=f(o.itemTypeName,o.itemName);if(a){var u=h(o.itemTypeName);4===n.location&&(u="Postmaster","Messages"!==a&&(a="Lost Items"));var c=[27147831,42955693,67667123,90237898,218050499,265815054,335523232,339830484,393928834,396000457,458051526,503662095,523254923,539209176,561917151,624069029,714364949,775290250,795669148,860021733,882909349,995864459,904421510,1066225282,1089438744,1107880514,1160431986,1220059831,1254374620,1254481871,1264686852,1323306343,1402638106,1451036562,1519653029,1550472824,1594939317,1656716862,1828077147,1847790745,1873618131,2012670844,2026407600,2083636246,2166567782,2204090140,2205157361,2218769485,2225640336,2254085097,2291003580,2328256155,2438950138,2465557612,2475938409,2480655802,2535110885,2557913516,2558819340,2582896251,2591286232,2642620856,2668404053,2729377859,2733667410,2741119693,2762611443,2773297359,2834869470,2858888526,3072387149,3013056390,3083393861,3102889189,3170350942,3252749793,3604975945,3698237992,3744470365,3904617893,3975149217,3992691386,4029879832,4068960035,4143281036,4160874107,4248486431],l=[null,"kinetic","arc","solar","void"][n.damageType],d={index:s(),owner:e,hash:n.itemHash,type:a,sort:u,tier:o.tierTypeName,name:o.itemName,icon:o.icon,inHoW:_.contains(c,o.itemHash),notransfer:"Postmaster"!==u?o.nonTransferrable:!0,id:n.itemInstanceId,equipped:n.isEquipped,equipment:n.isEquipment,complete:n.isGridComplete,hasXP:!!n.progression,xpComplete:!!n.progression&&0===n.progression.progressToNextLevel&&n.progression.currentProgress>0,amount:n.stackSize,primStat:n.primaryStat,stats:n.stats,maxStackSize:t[n.itemHash].maxStackSize,classType:o.classType,dmg:l,visible:!0};2809229973===n.itemHash&&(d.hasXP=!0,d.xpComplete=!0,d.complete=!0),d.complete&&(d.hasXP=!0,d.xpComplete=!0),"Basic"!==d.tier&&i.push(d)}}},o=a.getDefinitions().then(function(e){var n=r.bind(null,e);return _.each(t,n),i});return o}function p(e){switch(e){case 0:return"titan";case 1:return"hunter";case 2:return"warlock"}return"unknown"}function m(e){switch(e){case 3887404748:return"human";case 898834093:return"exo";case 2803282938:return"awoken"}return"unknown"}function v(e){switch(e){case 0:return"male";case 1:return"female"}return"unknown"}function f(e,t){return-1!=t.indexOf("Marks")?null:-1!=["Pulse Rifle","Scout Rifle","Hand Cannon","Auto Rifle","Primary Weapon Engram"].indexOf(e)?"Primary":-1!=["Sniper Rifle","Shotgun","Fusion Rifle","Sidearm","Special Weapon Engram"].indexOf(e)?-1!=["Vex Mythoclast","Universal Remote","No Land Beyond"].indexOf(t)?"Primary":"Special":-1!=["Rocket Launcher","Machine Gun","Heavy Weapon Engram"].indexOf(e)?"Heavy":-1!=["Titan Mark","Hunter Cloak","Warlock Bond","Class Item Engram"].indexOf(e)?"ClassItem":-1!=["Gauntlet Engram"].indexOf(e)?"Gauntlets":-1!=["Gauntlets","Helmet","Chest Armor","Leg Armor","Helmet Engram","Leg Armor Engram","Body Armor Engram"].indexOf(e)?"Body"===e.split(" ")[0]?"Chest":e.split(" ")[0]:-1!=["Titan Subclass","Hunter Subclass","Warlock Subclass"].indexOf(e)?"Class":-1!=["Restore Defaults"].indexOf(e)?"Armor":-1!=["Currency"].indexOf(e)?-1!=["Vanguard Marks","Crucible Marks"].indexOf(t)?"":"Material":-1!=["Public Event Completed"].indexOf(t)?"Messages":-1!=["Armor Shader","Emblem","Ghost Shell","Ship","Vehicle","Consumable","Material"].indexOf(e)?e.split(" ")[0]:null}function h(e){return-1!=["Pulse Rifle","Sniper Rifle","Shotgun","Scout Rifle","Sidearm","Hand Cannon","Fusion Rifle","Rocket Launcher","Auto Rifle","Machine Gun","Primary Weapon Engram","Special Weapon Engram","Heavy Weapon Engram"].indexOf(e)?"Weapons":-1!=["Titan Mark","Hunter Cloak","Warlock Bond","Helmet Engram","Leg Armor Engram","Body Armor Engram","Gauntlet Engram","Gauntlets","Helmet","Chest Armor","Leg Armor","Class Item Engram"].indexOf(e)?"Armor":-1!=["Restore Defaults","Titan Subclass","Hunter Subclass","Warlock Subclass","Armor Shader","Emblem","Ghost Shell","Ship","Vehicle","Consumable","Material","Currency"].indexOf(e)?"General":void 0}var g=[],y=0,b={getStores:c,getStore:l,setHeights:u};return b}angular.module("dimApp").factory("dimStoreService",e),e.$inject=["$rootScope","$q","dimBungieService","dimPlatformService","dimItemTier","dimCategory","dimItemDefinitions"]}(),function(){"use strict";function e(e,t,n,i,r){function o(e,t,n,i){var r;if(t.id!==n.id){var o=_.findIndex(t.items,function(t){return e.index===t.index});if(e.maxStackSize>1&&e.amount<e.maxStackSize&&(_.has(e,"moveAmount")&&e.moveAmount>0&&(r=_.reduce(t.items,function(t,n){return e.hash===n.hash&&(!_.has(n,"moveAmount")||_.has(n,"moveAmount")&&0===n.moveAmount)&&(null===t?t=n:t.amount>n.amount&&(t=n)),t},null),_.isNull(r)||e.moveAmount>e.amount&&(r.amount=r.amount+(e.amount-e.moveAmount)),e.amount=e.moveAmount),e.moveAmount=0,r=_.filter(n.items,function(t){return t.amount<e.maxStackSize&&t.hash===e.hash}),_.size(r)>0)){var a=r[0],s=a.amount+e.amount;e.moveAmount=e.amount,s<=e.maxStackSize?(a.amount=s,e.amount=0):(a.amount=a.maxStackSize,e.amount=s-e.maxStackSize)}e.owner=n.id,o>=0&&t.items.splice(o,1),e.amount>0&&n.items.push(e)}if(i){var u=_.findWhere(n.items,{equipped:!0,type:e.type});u.equipped=!1,e.equipped=!0}return e}function a(t){return r.when(e.getStores()).then(function(e){var n=null,i=_.find(e,function(e){return e.id===t.owner}),r=_.sortBy(e,function(e){return i.id===e.id?0:"vault"===e.id?1:2});return _.each(r,function(e){_.isNull(n)&&(n=s(t,e))}),n})}function s(e,t){var i=null,r={Legendary:0,Rare:1,Uncommon:2,Common:3,Exotic:5},o=_.chain(t.items).where({classType:e.classType}).sortBy(function(e){return r[e.tier]}).where({type:e.type,equipped:!1,equipment:!0}).value();if(_.size(o)>0&&(i=o[0],i.id===e.id&&i.hash===e.hash&&(i=_.size(o)>1?o[1]:null)),null!==i&&i.tier===n.exotic){var a=_(t.items).chain().filter(function(t){return t.equipped&&t.type!==e.type&&t.sort===e.sort&&t.tier===n.exotic});return 0===a.size().value()?i:null}return i}function u(n){return t.equip(n).then(e.getStore.bind(null,n.owner)).then(function(e){o(n,e,e,!0)})}function c(n,i){_.isUndefined(i)&&(i=!1);var s={source:null,target:null,similarItem:null};return a(n).then(function(t){return s.similarItem=t,!i&&t&&"Exotic"===t.tier?r.reject("There are no items to equip in the '"+n.type+"' slot."):t?e.getStore(n.owner):r.reject("There are no items to equip in the '"+n.type+"' slot.")}).then(function(t){return s.source=t,e.getStore(s.similarItem.owner)}).then(function(n){if(s.target=n,s.source.id===s.target.id)return null;var i,a=r.when();return"vault"!==s.similarItem.owner&&(a=e.getStore("vault").then(function(e){return i=e,t.transfer(s.similarItem,i)}).then(function(){o(s.similarItem,i,s.source,!1)})),a.then(function(){return t.transfer(s.similarItem,s.source)}).then(function(){o(s.similarItem,i?i:s.target,s.source,!1)})}).then(function(){return t.equip(s.similarItem)}).then(function(){return o(s.similarItem,s.source,s.source,!0)})["catch"](function(e){return r.reject(e)})}function l(t){return e.getStore("vault").then(function(e){return d(t,e,!1)})}function d(n,i,r){var a={source:null,target:i};return e.getStore(n.owner).then(function(e){return a.source=e,t.transfer(n,a.target)}).then(function(){return o(n,a.source,a.target,!1)}).then(function(e){return"vault"!==e.owner&&r?u(e):e})}function p(e,t){var i=r.defer(),o=i.promise,a=_(t.items).chain().filter(function(t){return t.equipped&&t.type!==e.type&&t.sort===e.sort&&t.tier===n.exotic});if(0===a.size().value())i.resolve(!0);else{var s=a.value()[0];c(s).then(function(e){i.resolve(!0)})["catch"](function(t){i.reject(new Error("'"+e.name+"' cannot be equipped because the exotic in the "+s.type+" slot cannot be unequipped."))})}return o}function m(t,n){var i=r.defer(),o=i.promise,a=0,s=0,u="vault"===n.id?{sort:t.sort}:{type:t.type},c=_(n.items).chain().where(u).size().value();t.maxStackSize>1?(a=_(n.items).chain().where({hash:t.hash}).pluck("amount").reduce(function(e,t){return e+t},0).value(),s=Math.ceil((a+t.amount)/t.maxStackSize)-Math.ceil(a/t.maxStackSize)):s=t.owner===n.id?0:1;var l=10;if("vault"===n.id)switch(t.sort){case"Weapons":case"Weapon":l=36;break;default:l=24}else switch(t.type){case"Material":case"Consumable":l=15;break;default:l=10}if(l>=c+s)if(t.owner!==n.id&&"vault"!==n.id){var d;"vault"!==t.owner?e.getStore("vault").then(function(e){return d=e,m(t,e)}).then(function(){i.resolve(!0)})["catch"](function(e){i.reject(e)}):i.resolve(!0)}else i.resolve(!0);else i.reject(new Error("There are too many '"+("vault"===n.id?t.sort:t.type)+"' items in the "+("vault"===n.id?"vault":"guardian")+"."));return o}function v(e,t){var n=r.defer(),i=n.promise,o="vault"===e.owner&&"vault"===t.id;return n.resolve(o?n.reject(new Error("Cannot process vault-to-vault transfers.")):!1),i}function f(e,t,n){return r(function(i,o){var a=[];a.push(v(n,t)),a.push(m(n,t)),"Exotic"===n.tier&&e&&a.push(p(n,t)),i(r.all(a))})}function h(t,n,i){var o={item:t,source:null,target:n,sameSource:t.owner===n.id,isVault:{source:"vault"===t.owner,target:"vault"===n.id}},a=e.getStore(t.owner).then(function(e){return o.source=e,f(i,n,t)}).then(function(e){var n=r.when();return o.isVault.source||o.isVault.target?o.isVault.source&&o.isVault.target||(o.isVault.source||o.isVault.target)&&(t.equipped&&(n=n.then(c.bind(null,t))),n=n.then(d.bind(null,t,o.target,i))):(o.source.id!=o.target.id&&(t.equipped&&(n=n.then(c.bind(null,t))),n=n.then(l.bind(null,t)).then(d.bind(null,t,o.target,i))),i?n=n.then(function(){return t.equipped?r.when(null):u(t)}):i||(n=n.then(function(){return t.equipped?c.bind(null,t)():r.when(null)}))),n=n.then(function(){t.moveAmount=0})})["catch"](function(e){return r.reject(e)});return a}function g(){var t=[],n=e.getStores();return angular.forEach(n,function(e){t=t.concat(e.items)}),t}function y(e,t,n,i){var r;r=i?i.items:g();var o;if(_.isObject(e)){var a=e;o=_.find(r,function(e){return e.id===a.id&&e.hash===a.hash})}else predicate={},_.isEmpty(e)||(predicate.id=e),_.isEmpty(t)||(predicate.hash=t),o=_.findWhere(r,predicate);return o}return{getSimilarItem:a,getItem:y,getItems:g,moveTo:h}}angular.module("dimApp").factory("dimItemService",e),e.$inject=["dimStoreService","dimBungieService","dimItemTier","dimCategory","$q"]}(),function(){"use strict";function e(e){function n(t,n,i){var r=t.vm;r.classTypeValues=[{label:"Any",value:-1},{label:"Warlock",value:0},{label:"Titan",value:1},{label:"Hunter",value:2}],r.classList={"loadout-create":!0},t.$on("dim-create-new-loadout",function(t,n){r.show=!0,e.dialogOpen=!0,r.loadout=angular.copy(r.defaults)}),t.$on("dim-delete-loadout",function(t,n){r.show=!1,e.dialogOpen=!1,r.loadout=angular.copy(r.defaults)}),t.$on("dim-edit-loadout",function(t,n){n.loadout&&(r.show=!0,e.dialogOpen=!0,r.loadout=n.loadout)}),t.$on("dim-store-item-clicked",function(e,t){r.add(t.item)})}return{controller:t,controllerAs:"vm",bindToController:!0,link:n,restrict:"A",scope:{},template:['<div ng-class="vm.classList" ng-show="vm.show">','  <div ng-messages="vm.form.name.$error" ng-if="vm.form.$submitted || vm.form.name.$touched">','    <div ng-message="required">A name is required.</div>','    <div ng-message="minlength">...</div>','    <div ng-message="maxlength">...</div>',"  </div>",'  <div class="loadout-content">','    <div class="content" style="margin: 15px; min-height: 88px;">','      <div id="loadout-options">','        <form name="vm.form">','          <input name="name" ng-model="vm.loadout.name" minlength="1" maxlength="50" required type="search" placeholder="Loadout Name..." />','          <select name="classType" ng-model="vm.loadout.classType" ng-options="item.value as item.label for item in vm.classTypeValues"></select>','          <input type="button" ng-disabled="vm.form.$invalid" value="Save" ng-click="vm.save()"></input>','          <input type="button" ng-click="vm.cancel()" value="Cancel"></input>','          <span>Items with the <img src="images/spartan.png" style="border: 1px solid #333; background-color: #f00; margin: 0 2px; width: 16px; height: 16px;  vertical-align: text-bottom;"> icon will be equipped.  Click on an item toggle equip.</span>','          <p id="loadout-error"></p>',"        </form>","      </div>",'      <span id="loadout-contents">','        <span ng-repeat="value in vm.types" class="loadout-{{ value }}">','          <div ng-repeat="item in vm.loadout.items[value]" ng-click="vm.equip(item)" id="loadout-item-{{:: $id }}" class="item" ng-class="{ \'complete\': item.complete}">','            <img ng-src="{{ item.icon }}">','            <div class="counter" ng-if="item.amount > 1">{{ item.amount }}</div>','            <div class="close" ng-click="vm.remove(item); vm.form.name.$rollbackViewValue(); $event.stopPropagation();"></div>','            <div class="equipped" ng-show="item.equipped"></div>','            <div class="damage-type" ng-if="item.sort === \'Weapons\'" ng-class="\'damage-\' + item.dmg"></div>',"          </div>","        </span>","      </span>","    </div>","  </div>","</div>"].join("")}}function t(e,t,n,i){var r=this;r.types=_.chain(t).values().flatten().map(function(e){return e.toLowerCase()}).value(),r.show=!1,e.dialogOpen=!1,r.defaults={classType:-1,items:{}},r.loadout=angular.copy(r.defaults),r.save=function(){_.has(r.loadout,"id")?e.saveLoadouts():e.saveLoadout(r.loadout),r.loadout=angular.copy(r.defaults),r.show=!1,e.dialogOpen=!1},r.cancel=function(){r.loadout=angular.copy(r.defaults),e.dialogOpen=!1,r.show=!1},r.add=function(e){if(e.equipment){var t=angular.copy(e),n=t.type.toLowerCase(),o=r.loadout.items[n]=r.loadout.items[n]||[],a=_.find(o,function(e){return e.id===t.id});_.isUndefined(a)&&_.size(o)<9&&(t.equipped=!1,"Class"===t.type&&_.has(r.loadout.items,"class")&&(r.loadout.items["class"].splice(0,r.loadout.items["class"].length),t.equipped=!0),o.push(t))}else i.pop("warning","","Only equippable items can be added to a loadout.")},r.remove=function(e){var t=e.type.toLowerCase(),n=r.loadout.items[t]=r.loadout.items[t]||[],i=_.findIndex(n,function(t){return t.id===e.id});i>=0&&n.splice(i,1)},r.equip=function(e){if(e.equipment){r.loadout.equipped;if("Class"!==e.type||e.equipped)if(e.equipped)e.equipped=!1;else{if(e.tier===n.exotic){var t=_.chain(r.loadout.items).values().flatten().findWhere({
sort:e.sort,tier:n.exotic,equipped:!0}).value();_.isUndefined(t)||(t.equipped=!1)}_.chain(r.loadout.items).values().flatten().where({type:e.type,equipped:!0}).each(function(e){e.equipped=!1}),e.equipped=!0}else e.equipped=!0}}}angular.module("dimApp").directive("dimLoadout",e),e.$inject=["dimLoadoutService"],t.$inject=["dimLoadoutService","dimCategory","dimItemTier","toaster"]}(),function(){"use strict";function e(){return{controller:t,controllerAs:"vm",bindToController:!0,restrict:"A",scope:{classType:"=dimClass",store:"=dimLoadoutPopup"},replace:!0,template:['<div class="loadout-popup-content">','  <div class="loadout-set" ng-click="vm.newLoadout($event)">+ Create Loadout</div>','  <div class="loadout-list">','    <div ng-repeat="loadout in vm.loadouts track by loadout.id" class="loadout-set">','      <span class="button-name" title="{{ loadout.name }}" ng-click="vm.applyLoadout(loadout, $event)">{{ loadout.name }}</span>','      <span class="button-delete" ng-click="vm.deleteLoadout(loadout, $event)">Delete</span>','      <span class="button-edit" ng-click="vm.editLoadout(loadout, $event)">Edit</span>',"    </div>","  </div>","</div>"].join("")}}function t(e,t,n,i,r,o,a){function s(t,n,c,l){if(t.length>0){var d=t.splice(0,1)[0],p=i.getItem(d);if("Class"===p.type&&(p=_.findWhere(u.store.items,{hash:d.hash})),p){var m,v=_.chain(u.store.items).filter(function(e){return p.type===e.type}).size().value(),f=o.when(p);if(10===v&&p.owner!==u.store.id){var h=c[p.type].splice(0,1);f=o.when(a.getStores()).then(function(e){return _.chain(e).filter(function(e){return"vault"!==e.id}).sortBy(function(e){return e.id===u.store.id?2:e.id===u.store.id?0:1}).value()}).then(function(e){return _.find(e,function(e){return _.chain(e.items).filter(function(e){return p.type===e.type}).size().value()<10})}).then(function(e){return m=e,i.moveTo(h[0],m)})}var g=f.then(function(){return i.moveTo(p,u.store,d.equipped)})["catch"](function(e){l.failed=!0,r.pop("error",p.name,e.message)})["finally"](function(){s(t,n,c,l)});e.loadingTracker.addPromise(g)}}else{var y="success",b="Your loadout has been transfered.";l.failed&&(y="warning",b="Your loadout has been transfered, with errors."),r.pop(y,n.name,b)}}var u=this;u.classTypeId=-1;var c={warlock:0,titan:1,hunter:2};u.classTypeId=c[u.classType]||0,n.getLoadouts().then(function(e){u.loadouts=_.sortBy(e,"name")||[],u.loadouts=_.filter(u.loadouts,function(e){return-1===e.classType||e.classType===u.classTypeId})}),u.newLoadout=function(n){t.closeAll(),e.$broadcast("dim-create-new-loadout",{})},u.deleteLoadout=function(t,i){n.deleteLoadout(t),e.$broadcast("dim-delete-loadout",{}),n.getLoadouts().then(function(e){u.loadouts=_.sortBy(e,"name")||[],u.loadouts=_.filter(u.loadouts,function(e){return-1===e.classType||e.classType===u.classTypeId})})},u.editLoadout=function(n,i){t.closeAll(),e.$broadcast("dim-edit-loadout",{loadout:n})},u.applyLoadout=function(e,n){t.closeAll();var i={failed:!1},r=_.chain(e.items).values().flatten().value(),o=_.chain(r).pluck("type").uniq().value(),a=_.chain(u.store.items).filter(function(e){return _.contains(o,e.type)}).filter(function(e){return!_.some(r,function(t){return t.id===e.id&&t.hash===e.hash})}).groupBy(function(e){return e.type}).value();s(r,e,a,i)}}angular.module("dimApp").directive("dimLoadoutPopup",e),e.$inject=[],t.$inject=["$rootScope","ngDialog","dimLoadoutService","dimItemService","toaster","$q","dimStoreService"]}(),function(){"use strict";function e(e){var t=this,n=null,i=null,r=null;t.showAbout=function(t){t.stopPropagation(),_.isNull(n)?(e.closeAll(),n=e.open({template:"views/about.html",overlay:!1,className:"about",scope:$("body > div").scope()}),$("body").addClass("about"),n.closePromise.then(function(){n=null,$("body").removeClass("about")})):n.close()},t.showSupport=function(t){t.stopPropagation(),_.isNull(i)?(e.closeAll(),i=e.open({template:"views/support.html",overlay:!1,className:"support",scope:$("body > div").scope()}),$("body").addClass("support"),i.closePromise.then(function(){i=null,$("body").removeClass("support")})):i.close()},t.showFilters=function(t){t.stopPropagation(),_.isNull(r)?(e.closeAll(),r=e.open({template:"views/filters.html",overlay:!1,className:"filters",scope:$("body > div").scope()}),$("body").addClass("filters"),setTimeout(function(){$("#filter-view span").each(function(){var e=$(this),t=e.text();e.click(function(){addFilter(t)})})},250),r.closePromise.then(function(){r=null,$("body").removeClass("filters")})):r.close()},t.closeLoadoutPopup=function(){_.isNull(n)&&_.isNull(i)&&_.isNull(r)||e.closeAll()}}angular.module("dimApp").controller("dimAppCtrl",e),e.$inject=["ngDialog"]}(),function(){"use strict";function e(){return{controller:t,controllerAs:"vm",bindToController:!0,scope:{},restrict:"A",template:['<select id="system" ng-if="vm.platforms.length > 1" ng-options="platform.label for platform in vm.platforms" ng-model="vm.active" ng-change="vm.update()"></select>','<span style="margin: 0 10px;" id="user" class="header-right">{{ vm.active.id }}</span>'].join("")}}function t(e,t,n,i){function r(){$.get("https://www.bungie.net","",function(){setTimeout(function(){var e=t.getPlatforms();i.loadingTracker.addPromise(e)},250)})}var o=this;o.active=null,o.platforms=null,o.update=function(){t.setActive(o.active)},r(),e.$on("dim-platforms-updated",function(e,t){o.platforms=t.platforms}),e.$on("dim-active-platform-updated",function(e,t){_.isNull(t.platform)?n.active=o.active=null:(_.isNull(o.active)||o.active.type!==t.platform.type)&&(n.active=o.active=t.platform)})}angular.module("dimApp").directive("dimPlatformChoice",e),e.$inject=[],t.$inject=["$scope","dimPlatformService","dimState","$rootScope"]}(),function(){"use strict";function e(){return{controller:t,controllerAs:"vm",bindToController:!0,restrict:"A",template:['<input placeholder="filter items or is:arc" type="search" name="filter" ng-model="vm.search" ng-model-options="{ debounce: 500 }" ng-trim="true" ng-change="vm.filter()">'].join("")}}function t(e,t,n){var i=this;e.$on("dim-stores-updated",function(e){i.filter()}),i.filter=function(){var e,o,a=i.search?i.search.toLowerCase():"",s=[],u=a.indexOf("is:")>=0;u?(e=a.split("is:"),_.each(e,function(e){e=e.trim(),""!==e&&(["arc","solar","void","kinetic"].indexOf(e)>=0?u="elemental":["primary","special","heavy","helmet","leg","gauntlets","chest","class","classitem"].indexOf(e)>=0?u="type":["common","uncommon","rare","legendary","exotic"].indexOf(e)>=0?u="tier":["incomplete"].indexOf(e)>=0?u="incomplete":["complete"].indexOf(e)>=0?u="complete":["xpincomplete"].indexOf(e)>=0?u="xpincomplete":["xpcomplete"].indexOf(e)>=0?u="xpcomplete":["upgraded"].indexOf(e)>=0?u="upgraded":["titan","hunter","warlock"].indexOf(e)>=0?u="classType":["dupe","duplicate"].indexOf(e)>=0&&(u="dupe"),s.push(r(e,u)))})):s.push(r(a,"")),o=function(e){return _.reduce(s,function(t,n){return t||n(e)},!1)},_.each(t.getStores(),function(e){_.chain(e.items).each(function(e){e.visible=!0}).filter(o).each(function(e){e.visible=!1})}),n(t.setHeights,32)};var r=function(e,n){var i={},r=function(e,t){return!0};switch(n){case"elemental":r=function(e,t){return t.dmg!==e};break;case"type":r=function(e,t){return t.type.toLowerCase()!==e};break;case"tier":r=function(e,t){return t.tier.toLowerCase()!==e};break;case"incomplete":r=function(e,t){return t.complete===!0||!t.primStat&&"Class"!==t.type||"Vehicle"===t.type||"Common"===t.tier&&"Class"!==t.type||t.xpComplete&&t.hasXP||!t.hasXP};break;case"complete":r=function(e,t){return t.complete===!1||!t.primStat&&"Class"!==t.type||"Vehicle"===t.type||"Common"===t.tier&&"Class"!==t.type};break;case"xpincomplete":r=function(e,t){return t.xpComplete&&t.hasXP||!t.hasXP};break;case"xpcomplete":r=function(e,t){return!t.xpComplete&&t.hasXP||!t.hasXP};break;case"upgraded":r=function(e,t){return t.complete===!0||!t.primStat&&"Class"!==t.type||"Vehicle"===t.type||"Common"===t.tier&&"Class"!==t.type||!t.xpComplete&&t.hasXP||!t.hasXP};break;case"dupe":r=function(e,n){if(!i.hasOwnProperty("dupes")){var r=_.chain(t.getStores()).map(function(e){return e.items}).flatten().sortBy("hash").value();i.dupes=[];for(var o=0;o<r.length-1;o++)r[o+1].hash==r[o].hash&&i.dupes.push(r[o].hash)}return!_.some(i.dupes,function(e){return n.hash===e})};break;case"classType":r=function(e,t){var n;switch(e){case"titan":n=0;break;case"hunter":n=1;break;case"warlock":n=2}return t.classType!==n};break;default:r=function(e,t){return-1===t.name.toLowerCase().indexOf(e)}}return r.bind(null,e)}}angular.module("dimApp").directive("dimSearchFilter",e),e.$inject=[],t.$inject=["$scope","dimStoreService","$timeout"]}(),function(){function e(e,t){return{restrict:"A",link:function(t,n,i,r){var o=function(e){n[0].contains(e.target)||t.$apply(i.dimClickAnywhereButHere)};e.on("click",o),t.$on("$destroy",function(){e.off("click",o)})}}}angular.module("dimApp").directive("dimClickAnywhereButHere",e),e.$inject=["$document","$parse"]}(),function(){"use strict";function e(e){return{controller:t,controllerAs:"vm",bindToController:!0,scope:{},template:['<div ng-repeat="store in vm.stores" class="storage" ng-class="{ guardian: store.id !== \'vault\', vault: store.id === \'vault\' }">','  <div dim-store-heading store-data="store"></div>','  <div dim-store-items store-data="store"></div>',"</div>"].join("")}}function t(e,t,n,i){var r=this;r.stores=null,e.$on("dim-active-platform-updated",function(e,o){var a=i.when(t.getStores(!0)).then(function(e){r.stores=e});n.loadingTracker.addPromise(a)})}angular.module("dimApp").directive("dimStores",e),e.$inject=["ngDialog"],t.$inject=["$scope","dimStoreService","$rootScope","$q"]}(),function(){"use strict";function e(e,n){function i(e,t,i){e.vm.onDrop=function(t,i,r){var o=e.vm,a=n.document.querySelector("#"+t);o.moveDroppedItem(angular.element(a).scope().item,r)}}return{controller:t,controllerAs:"vm",bindToController:!0,link:i,replace:!0,scope:{store:"=storeData"},template:["<div>",'  <div class="items {{ vm.store.id }}" data-type="item" data-character="{{ vm.store.id }}">','    <div ng-repeat="key in vm.keys" ng-init="value = vm.categories[key]" class="section {{ key.toLowerCase() }}">','      <div class="title">',"        <span>{{ key }}</span>","        <span class=\"bucket-count\" ng-if=\"vm.store.id === 'vault'\">{{ vm.sortSize[key] ? vm.sortSize[key] : 0 }}/{{ key === 'Weapons' ? 36 : 24 }}  </span>","      </div>",'      <div ng-repeat="type in value" class="sub-section sort-{{ type.toLowerCase() }}" ng-class="vm.data[vm.orderedTypes[type]] ? \'\' : \'empty\'" ui-on-drop="vm.onDrop($data, $event, false)" drop-channel="{{ type }}">','        <div ng-class="vm.styles[type].equipped" ng-if="vm.store.id !== \'vault\'" ui-on-drop="vm.onDrop($data, $event, true)" drop-channel="{{ type }}">','          <div ng-repeat="item in vm.data[vm.orderedTypes[type]].equipped track by item.index" dim-store-item store-data="vm.store" item-data="item"></div>',"        </div>",'        <div ng-class="vm.styles[type].unequipped" ui-on-drop="vm.onDrop($data, $event, false)" drop-channel="{{ type }}">','          <div ng-repeat="item in vm.data[vm.orderedTypes[type]].unequipped track by item.index" dim-store-item store-data="vm.store" item-data="item"></div>','          <div class="item-target"></div>',"        </div>","      </div>","    </div>","  </div>","</div>"].join("")}}function t(e,t,n,i,r,o,a){function s(){return"vault"===u.store.id&&(u.sortSize=_(u.store.items).chain().groupBy(function(e){return e.sort}).mapObject(function(e,t){return _.size(e)}).value()),_.chain(u.store.items).sortBy(function(e){return e.name}).sortBy(function(e){switch(e.tier){case"Exotic":return 0;case"Legendary":return 1;case"Rare":return 2;case"Uncommon":return 3;case"Common":return 4;default:return 5}}).sortBy(function(e){return u.orderedTypes[e.type]}).groupBy(function(e){return u.orderedTypes[e.type]}).mapObject(function(e,t){return _.groupBy(e,function(e){return e.equipped?"equipped":"unequipped"})}).value()}var u=this,c=["Class","Primary","Special","Heavy","Helmet","Gauntlets","Chest","Leg","ClassItem","Emblem","Armor","Ghost","Ship","Vehicle","Consumable","Material","Messages","Lost Items"];u.orderedTypes={},_.each(c,function(e,t){u.orderedTypes[e]=t}),u.sortSize=_(u.store.items).chain().groupBy(function(e){return e.sort}).mapObject(function(e,t){return _.size(e)}).value(),u.categories={Weapons:["Class","Primary","Special","Heavy"],Armor:["Helmet","Gauntlets","Chest","Leg","ClassItem"],General:["Consumable","Material","Emblem","Armor","Ghost","Ship","Vehicle"],Postmaster:["Messages","Lost Items"]},u.keys=_.keys(u.categories),u.styles={Class:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Primary:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Special:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Heavy:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Helmet:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Gauntlets:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Chest:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Leg:{equipped:"equipped equippable",unequipped:"unequipped equippable"},ClassItem:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Emblem:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Armor:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Ghost:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Ship:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Vehicle:{equipped:"equipped equippable",unequipped:"unequipped equippable"},Consumable:{equipped:"",unequipped:"unequipped equippable"},Material:{equipped:"",unequipped:"unequipped equippable"},Messages:{equipped:"",unequipped:"unequipped equippable"},"Lost Items":{equipped:"",unequipped:"unequipped equippable"}},u.moveDroppedItem=function(e,o){var s=null,c=u.store;if(e.owner===u.store.id){if(e.equipped&&o||!e.equipped&&!o)return;s=r.when(u.store)}else s=n.getStore(e.owner);var l;return e.notransfer&&e.owner!==c.id?r.reject(new Error("Cannot move class to different store.")):(s=s.then(function(e){l=e}).then(i.moveTo.bind(null,e,c,o))["catch"](function(t){a.pop("error",e.name,t.message)}),void t.loadingTracker.addPromise(s))},e.$watch("vm.store.items",function(e){u.data=s(),o(n.setHeights,0)},!0)}angular.module("dimApp").directive("dimStoreItems",e),e.$inject=["dimStoreService","$window"],t.$inject=["$scope","$rootScope","dimStoreService","dimItemService","$q","$timeout","toaster"]}(),function(){"use strict";function e(e,n,i){function r(e,t,r){var o=e.vm,a=null;t[0].querySelector(".img").style.backgroundImage="url(http://www.bungie.net"+o.item.icon+")",o.clicked=function(r,o){o.stopPropagation(),_.isNull(a)?(n.closeAll(),i.dialogOpen?i.addItemToLoadout(r):(a=n.open({template:'<div ng-click="$event.stopPropagation();" dim-click-anywhere-but-here="vm.closePopup()" dim-move-popup dim-store="vm.store" dim-item="vm.item"></div>',plain:!0,appendTo:'div[id="item-'+e.$id+'"]',overlay:!1,className:"move-popup"+($("body").width()-$(t).offset().left-320<0?" move-popup-right":""),showClose:!1,scope:e}),a.closePromise.then(function(e){a=null}))):a.close()},o.closePopup=function(){_.isNull(a)||a.close()}}return{bindToController:!0,controller:t,controllerAs:"vm",link:r,replace:!0,scope:{store:"=storeData",item:"=itemData"},template:['<div ui-draggable="{{ (vm.item.type !== \'Lost Items\') && (vm.item.type !== \'Messages\')  }}" id="item-{{:: $id }}" drag-channel="{{ vm.item.type }}" title="{{ vm.item.primStat.value }} {{ vm.item.name }}" alt="{{ vm.item.primStat.value }} {{ vm.item.name }}" drag="\'item-\' + $id" class="item" ng-class="{ \'search-hidden\': !vm.item.visible, \'complete\': vm.item.complete}">','  <div ui-draggable="false" class="img" ng-class="{ \'how\': vm.item.inHoW }" style="background-size: 44px 44px;" ng-click="vm.clicked(vm.item, $event)"></div>','  <div ui-draggable="false" class="counter" ng-if="vm.item.amount > 1">{{ vm.item.amount }}</div>','  <div ui-draggable="false" class="damage-type" ng-if="vm.item.sort === \'Weapons\'" ng-class="\'damage-\' + vm.item.dmg"></div>',"</div>"].join("")}}function t(e){var t=this;t.itemClicked=function(t){e.$broadcast("dim-store-item-clicked",{item:t})}}angular.module("dimApp").directive("dimStoreItem",e),e.$inject=["dimStoreService","ngDialog","dimLoadoutService"],t.$inject=["$rootScope"]}(),function(){"use strict";function e(e){function n(t,n){var i=t.vm,r=null;i.openLoadoutPopup=function(n){n.stopPropagation(),_.isNull(r)?(e.closeAll(),r=e.open({template:'<div ng-click="$event.stopPropagation();" dim-class="vm[\'class\']" dim-click-anywhere-but-here="vm.closeLoadoutPopup()" dim-loadout-popup="vm.store"></div>',plain:!0,appendTo:'div[loadout-id="'+i.store.id+'"]',overlay:!1,className:"loadout-popup",showClose:!1,scope:t}),r.closePromise.then(function(e){r=null})):r.close()},i.closeLoadoutPopup=function(){_.isNull(r)||r.close()},n.addClass("character"),i.isGuardian&&(n[0].querySelector(".character-box").style.backgroundImage="url("+i.characterBoxUrl+")",n[0].querySelector(".emblem").style.backgroundImage="url("+i.emblemUrl+")",i.maxLevel&&n[0].querySelector(".level").classList.add("maxLevel"))}return{controller:t,controllerAs:"vm",bindToController:!0,scope:{store:"=storeData"},link:n,template:["<div class=\"character-box\" ng-class=\"vm.isGuardian ? '' : 'vault-box'\">",'  <div class="emblem" ng-show="vm.isGuardian"></div>','  <div class="class">{{ vm.class || "Vault" }}</div>','  <div class="race-gender" ng-show="vm.isGuardian">{{ vm.race }} {{ vm.gender }}</div>','  <div class="level" ng-show="vm.isGuardian" ng-class="vm.isPrestigeLevel ? \'prestige\' : \'\'">{{ vm.level }}</div>','  <div class="levelBar" ng-show="vm.isGuardian">',"    <div class=\"barFill\" ng-class=\"vm.isPrestigeLevel ? 'prestige' : ''\" ng-style=\"{width: vm.percentToNextLevel + '%'}\"></div>","  </div>","</div>",'<div class="loadout-button" ng-show="vm.isGuardian" ng-click="vm.openLoadoutPopup($event)">&#x25BC;</div>','<div loadout-id="{{ vm.store.id }}" style="position: relative;"></div>'].join("")}}function t(){var e=this;e.isGuardian="vault"!==e.store.id,e["class"]=e.store["class"],e.level=e.store.level,e.race=e.store.race,e.gender=e.store.gender,e.isPrestigeLevel=e.store.isPrestigeLevel,e.percentToNextLevel=e.store.percentToNextLevel,e.maxLevel=e.store.level>=20,e.characterBoxUrl="http://bungie.net"+e.store.background,e.emblemUrl="http://bungie.net"+e.store.icon}angular.module("dimApp").directive("dimStoreHeading",e),e.$inject=["ngDialog"],t.$inject=[]}(),function(){"use strict";function e(e){return{controller:t,controllerAs:"vm",bindToController:!0,restrict:"A",scope:{store:"=dimStore",item:"=dimItem"},replace:!0,template:['<div class="move-popup">','  <div dim-move-item-properties="vm.item"></div>','  <div class="locations" ng-repeat="store in vm.stores">','    <div class="move-button move-vault" ng-class="{ \'little\': item.notransfer }" ','      ng-if="vm.canShowVault(vm.item, vm.store, store)" ng-click="vm.moveToVault(store, $event)" ','      data-type="item" data-character="{{ store.id }}">',"      <span>Vault</span>","    </div>",'    <div class="move-button move-store" ng-class="{ \'little\': item.notransfer }" ','      ng-if="vm.canShowStore(vm.item, vm.store, store)" ng-click="vm.moveToGuardian(store, $event)" ','      data-type="item" data-character="{{ store.id }}" style="background-image: url(http://bungie.net{{ store.icon }})"> ',"      <span>Store</span>","    </div>",'    <div class="move-button move-equip" ng-class="{ \'little\': item.notransfer }" ','      ng-if="vm.canShowEquip(vm.item, vm.store, store)" ng-click="vm.moveToEquip(store, $event)" ','      data-type="equip" data-character="{{ store.id }}" style="background-image: url(http://bungie.net{{ store.icon }})">',"      <span>Equip</span>","    </div>","  </div>","</div>"].join("")}}function t(e,t,n,i,r,o){function a(t,i){var r=n.moveTo(c.item,t)["catch"](function(e){o.pop("error",c.item.name,e.message)});e.loadingTracker.addPromise(r)}function s(t,i){var r=n.moveTo(c.item,t)["catch"](function(e){o.pop("error",c.item.name,e.message)});e.loadingTracker.addPromise(r)}function u(t,i){var r=n.moveTo(c.item,t,!0)["catch"](function(e){o.pop("error",c.item.name,e.message)});e.loadingTracker.addPromise(r)}var c=this;c.moveToVault=s,c.moveToEquip=u,c.moveToGuardian=a,c.stores=t.getStores(),c.canShowItem=function(e,t,n){var i=!1;if("vault"===e.id){if("vault"===n.id)return!1}else"vault"===n.id||n.id===e.owner;return i},this.canShowVault=function(e,t,n){return"vault"===t.id?!1:"vault"!==n.id?!1:e.notransfer?!1:!0},this.canShowStore=function(e,t,n){if("vault"===n.id)return!1;if(e.notransfer){if(e.equipped&&t.id===n.id)return!0}else{if(t.id!==n.id)return!0;if(e.equipped)return!0}return!1},this.canShowEquip=function(e,t,n){if("vault"===n.id)return!1;if(!e.equipment)return!1;if(e.notransfer){if(!e.equipped&&t.id===n.id&&"Postmaster"!==e.sort)return!0}else{if(t.id!==n.id&&"Postmaster"!==e.sort)return!0;if(!e.equipped&&"Postmaster"!==e.sort)return!0}return!1}}angular.module("dimApp").directive("dimMovePopup",e),e.$inject=["ngDialog"],t.$inject=["$rootScope","dimStoreService","dimItemService","ngDialog","$q","toaster"]}(),function(){"use strict";function e(e){return{bindToController:!0,controller:t,controllerAs:"vm",scope:{item:"=dimMoveItemProperties"},restrict:"A",replace:!0,template:['<div ng-class="vm.classes">','  <span><a target="_new" href="http://db.planetdestiny.com/items/view/{{vm.item.hash}}">{{vm.title}}</a></span>','  <span ng-show="vm.light > 0"> &#10022; {{ vm.light }}</span>','  <span ng-repeat="stat in vm.stats"> | {{ stat.label }} {{ stat.value }}</span>',"</div>"].join("")}}function t(e){var t=this;if(t.classes={"item-name":!0,"is-arc":!1,"is-solar":!1,"is-void":!1},t.title=e.trustAsHtml(t.item.name),t.light=0,t.stats=[],t.item.primStat)if(3897883278===t.item.primStat.statHash){4===t.item.stats.length&&(t.light=t.item.stats[0].value);for(var n=["Int:","Dis:","Str:"],i=0,r=0;r<n.length;r++)i=t.item.stats[r+(4===t.item.stats.length?1:0)].value,0!==i&&t.stats.push({label:n[r],value:i})}else if(368428387===t.item.primStat.statHash){switch(t.item.dmg){case"arc":t.classes["is-arc"]=!0;break;case"solar":t.classes["is-solar"]=!0;break;case"void":t.classes["is-void"]=!0}t.stats.push({label:"Atk:",value:t.item.primStat.value})}}angular.module("dimApp").directive("dimMoveItemProperties",e),e.$inject=["$sce"],t.$inject=["$sce"]}();